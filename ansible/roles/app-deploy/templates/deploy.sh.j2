#!/bin/bash
# Deployment script for Food Delivery Application
# This script pulls latest images from ECR and redeploys the application

set -e

APP_DIR="{{ app_dir }}"
AWS_REGION="{{ aws_region }}"
ECR_REGISTRY="{{ ecr_registry }}"

cd $APP_DIR

export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

echo "================================================"
echo "Food Delivery Application Deployment"
echo "================================================"

echo "üì¶ Logging into Amazon ECR..."
aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY

echo "üîÑ Pulling latest images from ECR..."
docker compose pull || docker-compose pull

echo "üõë Stopping existing containers..."
docker compose down || docker-compose down

echo "üöÄ Starting containers with latest images..."
docker compose up -d || docker-compose up -d

echo "‚è≥ Waiting for services to be healthy..."
sleep 15

echo "üîç Checking container status..."
docker compose ps || docker-compose ps

echo "================================================"
echo "‚úÖ Deployment Complete!"
echo "================================================"
echo ""
echo "Access your application:"
echo "  Frontend: http://{{ ansible_host }}"
echo "  Backend:  http://{{ ansible_host }}/api"
echo "  Admin:    http://{{ ansible_host }}/admin"
echo ""
echo "View logs: docker compose logs -f || docker-compose logs -f"
echo "================================================"